<!doctype html><html lang=ja dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>NSや周辺サービスをDockerで構築するときの備忘録 | 漬けなくてもおいしい</title><meta name=keywords content="技術,Simutrans,NetSimutrans,Docker,IPoE"><meta name=description content="あるいはどんなネット環境の人でもNSを立てることができる最強のフローチャート"><meta name=author content="Simutrans Advent Calendar 2025 17日目"><link rel=canonical href=https://www.araduke.net/posts/251217/><link crossorigin=anonymous href=/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css integrity="sha256-NDzEgLn/yPBMy+XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as=style><link rel=icon href=https://www.araduke.net/sushi64x64.png><link rel=icon type=image/png sizes=16x16 href=https://www.araduke.net/sushi16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.araduke.net/sushi32x32.png><link rel=apple-touch-icon href=https://www.araduke.net/maguro.png><link rel=mask-icon href=https://www.araduke.net/maguro.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ja href=https://www.araduke.net/posts/251217/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://www.araduke.net/posts/251217/"><meta property="og:site_name" content="漬けなくてもおいしい"><meta property="og:title" content="NSや周辺サービスをDockerで構築するときの備忘録"><meta property="og:description" content="あるいはどんなネット環境の人でもNSを立てることができる最強のフローチャート"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-12-26T01:31:53+09:00"><meta property="article:modified_time" content="2025-12-26T01:31:53+09:00"><meta property="article:tag" content="技術"><meta property="article:tag" content="Simutrans"><meta property="article:tag" content="NetSimutrans"><meta property="article:tag" content="Docker"><meta property="article:tag" content="IPoE"><meta property="og:image" content="https://www.araduke.net/maguro.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.araduke.net/maguro.png"><meta name=twitter:title content="NSや周辺サービスをDockerで構築するときの備忘録"><meta name=twitter:description content="あるいはどんなネット環境の人でもNSを立てることができる最強のフローチャート"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.araduke.net/posts/"},{"@type":"ListItem","position":2,"name":"NSや周辺サービスをDockerで構築するときの備忘録","item":"https://www.araduke.net/posts/251217/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"NSや周辺サービスをDockerで構築するときの備忘録","name":"NSや周辺サービスをDockerで構築するときの備忘録","description":"あるいはどんなネット環境の人でもNSを立てることができる最強のフローチャート","keywords":["技術","Simutrans","NetSimutrans","Docker","IPoE"],"articleBody":"この記事はSimutrans Advent Calendar 2025の17日目のものです。\nはじめに Netsimutrans（以下NS）はさまざまな方法で構築でき、この大遅刻記事が参加しているSimutrans Advent Calendar 2025に限ってもWindows環境×ポート開放、ポート開放不要、Linux環境（Extended）など、OS・Simutransの種類・インターネットへの公開方法の組み合わせがそれぞれ異なる構築方法が紹介されています。\n本稿ではLinuxでDockerを使い、ヘッドレスOTRP・Discord Bot・nginxを動かすことで、Simutrans World Monitorが使えてアドオン追加はDiscordサーバーにPakファイルを投げて更新はbatファイルを叩いて待っていれば済むNSの構築の仕方を話していきます。\nヘッドレスなOTRPとアドオン追加・更新の自動化はそれぞれ詳しい記事がすでに存在するのですが、環境など細かいところが異なっているので改めて取り上げたいと思います。\n…こういう考えの人がいるせいで、個別具体的な記事が増えていくのでしょう。そこで本稿では個別具体的でない記事ということをアピールするためはじめにNSのインターネットへの公開方法を一通りまとめてみました。\n質問に答えるだけでNSが立つフローチャート 質問１　サーバーとして使える物理PCとネット環境はありますか？ はい：質問２へ いいえ：VPSサーバーを契約しましょう 質問２　ポート開放はできますか？ はい：お好きな番号を開放しましょう いいえ・分からない：質問３へ 質問３　ネットの接続方法はIPoE（IPv4 over IPv6やMAP-E、OCNバーチャルコネクトやv6プラスみたいな名前）ですか？ はい：利用可能ポート番号の範囲から解放しましょう いいえ：以下のどちらかを選んでください GCEの無料枠でVPNサーバーを立てる ［デメリット］レイテンシ（遅延）が増える 参加者にCloudflaredかTailscaleを入れてもらう ［デメリット］入れてもらう手間・申し訳なさの発生 質問１　サーバーとして使える物理PCとネット環境はありますか？ NSをしたい期間（24時間365日かもしれないし、毎週土曜朝に起動して日曜夜に落とすだけで事足りるかもしれない）に起動し続けられるPCとネット環境さえあれば、NSは無料で立てることができます。\nポート開放によるリスクを度外視すれば、ポートが開けられないだけでは財布を開こうとしなくていいのです。\nなお、2.4GHzのWi-Fiでネットに繋げているために親が電子レンジを使うと通信が切れるのならルーターから有線で繋げられる位置にPCを移動し、雷雲が近づくと親がルーターのコンセントごと引っこ抜いてしまうのなら説得してやめてもらいましょう。\n居住形態によってこんな風に立ちはだかる大小の壁を乗り越えられなさそうであれば、以下の記事のようにVPSサーバーを借りてNSを立てることになります。\nこの手順で参考になる記事 【令和最新版】「世界一快適なNS」を目指して【Simutrans Advent Calendar 2022】 - AhozuraNS Simutrans Laboratory アドカレ最終日の記事（おそらく）→　NS鯖をAWSで立てたらおいくら万円かかんねんアメカス守銭奴SP【Simutrans Advent Calendar 2025 | 25日目】 - Nain-simutransRoom 質問２　ポート開放はできますか？ ポート開放が可能ならもはや言うことはありませんが、セキュリティリスクを考えると13353番が有名なポート番号かどうかは置いておいて別の番号を開放し、参加者にはポート番号付きのサーバーアドレスを打ってもらう方がいいかもしれません。\nまたいずれも後述しますが、レイテンシ（遅延）を受け入れるのならVPNを立てる、あるいは参加者に別途ソフトを入れてもらい家の物理PCはポート開放しないでおくのが一番安全といえます。\nこの手順で参考になる記事 ahakuokuのHP - サルでもわかるNS運営 質問３　ネットの接続方法はIPoEですか？ まずネットの接続方法はこのサイト（OCN IPoE接続環境確認サイト）か、ルーターの設定画面、最悪プロバイダーとの契約書で確認できます。IPoEやIPv4 over IPv6などとあれば、ルーターの設定画面やこのサイト（IPv6(MAP-E方式)使用可能ポート確認）で確認できる利用可能ポート番号の中でポート開放ができます。\n利用可能ポート番号に13353が含まれていることは稀なので、上述したようにサーバーアドレスはポート番号付きになるほか、IPoEでもDS-Liteというものだった場合ポート開放ができません。\nこれは、IPoEという接続方法は普通の方法（PPPoEという）と違いグローバルIPv4アドレスをほかのユーザーと共有しており、MAP-Eという方式ではそのアドレスのポート番号のうちいくつかが利用可能ポートとして割り当てられるのに対し、DS-Liteでは割り当てられないためです。\nNECのルーターではホーム\u003e情報\u003e現在の状態の下の方に利用可能ポート一覧がある あとは普通にポート開放ができる場合と手順は同じです。\nポート開放できないときの選択肢　すなわち最も安全な択 DS-Lite方式でネットに繋いでいるなどでポート開放ができない場合、またセキュリティリスクを考えるとNSの立てるには以下の選択肢が残ります。いずれも無料なのでNSを立てないという道はありません。\nGCEの無料枠でVPNサーバーを立てる Googleのクラウドサービス Google CloudのCompute Engineには無料枠があり、2025年現在米国リージョンのe2-micro（一番低いスペック）インスタンスおよび外部IPv4アドレスを永続的に無料で利用できます。\n無料枠のインスタンスをVPSサーバーとして使うのは無理がありますが、IPv4アドレスが付いてくるのでここで通信を受け取り、自宅PCに転送するVPNサーバー、いわゆる踏み台サーバーとして使うことができます。\nポート開放が不要で、VPNサーバーと自宅PCとの通信はTailscaleやZeroTierなどですればポート開放するよりもセキュリティリスクは数倍低くなります。\n問題はNSと参加者双方が日本に居てもVPNサーバーを経由、すなわち太平洋を往復しながら通信するためレイテンシ（遅延）が増えてしまうことで、リージョンを日本に変更すると月額課金が発生してしまうことです。\n私はこの方法で身内マイクラ鯖を動かしていましたが、日本リージョンにしてから月あたり1000円前後が持っていかれていました。\nこの方法でNSを立てている記事がないためマイクラ鯖の例となりますが、動かすゲームが違うだけで同じTCP通信なので参考にはできると思います。遅延のなかでのSimutransの操作感は分かりませんが。\nこの手順で参考になる記事 GCPの無料枠で作ったVPSを通してマイクラ自宅サーバーを公開する | やよい.⁸⁴¹ 参加者にCloudflaredかTailscaleを入れてもらう 最終手段かつ最も安全な方法といえるのがこれで、Cloudflare TunnelではNSと参加者間に通信のトンネルを作り、Tailscaleでは仮想ネットワーク内でNSと参加者が通信する形で、サーバー側のポート開放なしでNSが実現できます。いずれも参加者にはCloudflaredかTailscaleアプリを入れてもらわないといけません。\nCloudflareでは独自ドメインが必要なうえ、接続するためにコマンドプロントなどでコマンドを打ってもらう必要がありますが、Tailscaleではサーバー機の共有リンクを踏んでもらえば、以降はサーバー機のTailscale上のIPアドレスを入れるだけで接続が可能です（Tailscaleが裏で起動してる必要はあり）。\nなお、Tailscaleの共有はネットワーク丸ごと共有するのと各マシンを共有するの（Node Sharing）の2つがあり、前者は無料プランだと共有できる人数が3ユーザーまでなのですが、NSをやるにあたってはNode Sharingで十分なはずです。\nこの手順で参考になる記事 Cloudflare CloudflareTunnelでポート開放不要のNetSimutransを楽しもう！【Simutrans Advent Calender 2025】 - AhozuraNS Simutrans Laboratory Tailscale（Minecraftだけど） tailscale を用いた Minecraft サーバー接続 (ACL制御) [TrueNAS] #Minecraft - Qiita いずれかの方法を取れば無料で（一部除く）NSが立てられます！　今日からあなたも鯖主です！！！！ 公式wiki以外のすべてを疑え いよいよ本題のヘッドレスOTRPのビルドに移りますが、冒頭で触れたようにDockerでのビルドは先駆者様がいます。\nSimutrans OTRPのHeadlessサーバーを建てるのに苦労した話 #game - Qiita\nではこの記事を見ればよいですね。解散！\n…とはいきません。見出しに書いてあることを読んでもらいたいのですが、2025年現在のLinux環境でのビルドではconfig.defaultを書き換える必要はなくなっているため、ネット上に数多くあるビルド方法のほぼすべては過去のものといえるのです（日本語wikiの記載変えたほうがよくない？）。\nそのため、先駆者様の記事も疑ってみましょう。公式Wikiのビルド方法によると、makeでのビルドは必要なライブラリを入れた後に\nautoconf ./configure make -j $(nproc) と打てばビルドに進めるようです。なお、実際にはautoconfを実行すると\nconfigure.ac:175: warning: AC_OUTPUT should be used without arguments. configure.ac:175: You should run autoupdate. と言われるのでautoupdateをしてからのautoconfとなります。\nところが同記事のDockerfileではmakeの前にしているのはautoconf /simutrans/configure.ac（autoconfで付けられた実行権限でconfigureを叩く場面のところ、叩いてるのはconfigure.acだし、autoconfは引数なしで動くはず）のみで、別途sedコマンドなどでconfig.defaultの書き換えもしてないようです。そのため、makeしても\nMakefile:34: *** Unkown BACKEND \"\", must be one of \"gdi sdl sdl2 mixer_sdl mixer_sdl2 posix\". Stop. というおそらくSimutransのビルドに挑戦した人が最も多く見るであろうエラーが返されます。\n人様の記事を疑ったので、この記事も疑ってみましょう。buildできないDockerfileのままで良しとする人はそんなに存在しないと考えられるため、この記事ではうそを言って先駆者様の記事を貶してるといえます。\nそこで、以下にこの記事においてちゃんと動くと主張されているDockerfileを示しますので、先駆者様のDockerfileと併せて\ndocker run -dit ubuntu:latest docker exec -it (コンテナ名orID) して、それぞれの内容を実行してみてmakeが通るか試してみてください。\nちなみに、Windows環境ではSimutransのexeファイルをサーバーモードで実行すればソースコードからビルドという七面倒な手順を踏まずにNSを立てれるので、Linux環境でもできないかとOTRPのReleaseから最新の実行ファイルを取ってきました。以下のDockerfileなどで動作中のNSのファイル群に置いてビルドしたsimの代わりに実行してみると、\n./sim-linux-OTRPv48_2: error while loading shared libraries: libminiupnpc.so.17: cannot open shared object file: No such file or directory よく分からないのですがダメみたいです。\nDockerコンテナなんもわからん　でも使ったほうがいい NSの実行ではsystemdやnohupなどでずっと実行されているようにすることが大切ですが、たった5MBの実行ファイルのためだけにDocker使うんですか？？？（意訳）の声を跳ねのけてDockerを使いましょう。アドオンフォルダやセーブデータを適切に管理しておけば、本体バージョンのアップデートなどが簡単に行えます。\nDockerfile FROM ubuntu:latest ARG SIMUTRANS_VERSION # SIMUTRANS_VERSIONが設定されていない場合はビルドを失敗させる RUN if [ -z \"${SIMUTRANS_VERSION}\" ]; then \\ echo \"Error: SIMUTRANS_VERSION build argument is not set. Please use --build-arg SIMUTRANS_VERSION=.\"; \\ exit 1; \\ fi ENV SIMUTRANS_VERSION=${SIMUTRANS_VERSION} # 必要なパッケージのインストール RUN apt-get update \u0026\u0026 apt-get install -y \\ wget unzip autoconf zstd make gcc g++ \\ zlib1g-dev libbz2-dev libpng-dev cron curl vim \\ libsdl2-dev xvfb x11vnc websockify python3-websockify novnc fluxbox # simutransのソースコードのダウンロード、展開 WORKDIR /tmp RUN wget \"https://github.com/teamhimeh/simutrans/archive/refs/tags/${SIMUTRANS_VERSION}.zip\" \u0026\u0026 \\ unzip \"${SIMUTRANS_VERSION}.zip\" # Simutransのビルドディレクトリに移動 # v44_3.zip が simutrans-44_3/ に展開されることを想定し、 # ${SIMUTRANS_VERSION#v} を使って動的にパスを生成 WORKDIR \"/tmp/simutrans-${SIMUTRANS_VERSION#v}\" RUN autoupdate \u0026\u0026 \\ autoconf \u0026\u0026 \\ ./configure \u0026\u0026 \\ make DEBUG=1 # nettoolsのビルド WORKDIR \"/tmp/simutrans-${SIMUTRANS_VERSION#v}/nettools\" RUN make # get_lang_files.sh の実行とtextフォルダの取得 WORKDIR \"/tmp/simutrans-${SIMUTRANS_VERSION#v}\" RUN ./get_lang_files.sh # 最終的なディレクトリを用意 WORKDIR /app # 1. sim実行ファイルのコピー RUN cp \"/tmp/simutrans-${SIMUTRANS_VERSION#v}/sim\" . # 2. nettoolsフォルダ全体のコピー RUN cp -r \"/tmp/simutrans-${SIMUTRANS_VERSION#v}/nettools\" . # 3. textフォルダのコピー（実行ファイルと同じ階層へ） RUN cp -r \"/tmp/simutrans-${SIMUTRANS_VERSION#v}/simutrans/text\" /app/ RUN cp -r \"/tmp/simutrans-${SIMUTRANS_VERSION#v}/simutrans/font\" /app/ RUN cp -r \"/tmp/simutrans-${SIMUTRANS_VERSION#v}/simutrans/themes\" /app/ RUN cp -r \"/tmp/simutrans-${SIMUTRANS_VERSION#v}/simutrans/script\" /app/ COPY save.sve /app/server13353-network.sve COPY sqai_hm_monitor /app/ai/sqai_hm_monitor/ COPY start.sh /app/start.sh COPY savecron /app/savecron COPY save.sh /app/save.sh RUN chmod +x /app/start.sh /app/save.sh # ビルド成果物を除いた中間ファイルを削除 RUN rm -rf /tmp/* # コンテナ起動時に実行するコマンド CMD [\"/app/start.sh\"] start.sh #!/bin/bash set -e cd /app crontab /app/savecron cron /app/sim -server 13353 -server_admin_pw 0000 -objects pak.nippon -log 1 -debug 4 -lang ja -singleuser -load ../server13353-network.sve save.sh #!/bin/bash SAVE_DIR=\"/app/autosave\" SAVE_FILE=\"/app/server13353-network.sve\" NETTOOL=\"/app/nettools/nettool\" mkdir -p \"$SAVE_DIR\" echo \"[$(date '+%Y-%m-%d %H:%M:%S')] save.sh started\" \"$NETTOOL\" -p 0000 say \"10秒後に自動セーブを行います。\" sleep 10 \"$NETTOOL\" -p 0000 force-sync sleep 10 cp \"$SAVE_FILE\" \"$SAVE_DIR/$(date '+%Y%m%d-%H%M').sve\" #sveファイルが100個より多くなったら1個消す file_count=$(find \"$SAVE_DIR\" -maxdepth 1 -type f -name '*.sve' | wc -l) if [ \"$file_count\" -gt 100 ]; then old_file=$(find \"$SAVE_DIR\" -maxdepth 1 -type f -name '*.sve' -printf '%T@ %p\\n' | sort -n | head -n 1 | awk '{print $2}') if [ -n \"$old_file\" ]; then rm -v \"$old_file\" fi fi savecron */30 * * * * /app/save.sh \u003e\u003e /app/save.log 2\u003e\u00261 私が運営をさせてもらっている、とあるNSで実際に使っているヘッドレスOTRPコンテナのためのDockerfileとなかまたちはこんな感じです。\ngit cloneすればsimutransフォルダとしてDLできるのでフォルダ名周りのややこしい処理が要らなくなるほか、save.shでは10日でsveファイルが削除される欠陥構造のため、コピペしてそのまま使えるとはいえません。生成AIに渡してこの段落の文章を申し送り事項として送り付ければ直してくれることでしょう\nなお、ヘッドレスなのにDockerfileにてGUIライブラリなどをインストールする記述がありますが、これはSimutrans World Monitorで必要なAIプレイヤーが追加されたセーブデータをWindows環境で用意するのがパスの都合で面倒だったので、コンテナ内でGUIのSimutransを立ち上げAIプレイヤーを追加できるよう、NoVNCを実行できるようにしているためです。\n参考）このコンテナ内でNoVNCを使いGUIのSimutransを起動する Xvfb :99 -screen 0 1024x768x24 \u0026 export DISPLAY=:99 x11vnc -display :99 -forever -nopw -shared -bg git clone https://github.com/novnc/noVNC.git /opt/novnc /opt/novnc/utils/novnc_proxy --vnc localhost:5900 --listen 6080 \u0026 DISPLAY=:99 ./sim -server 13353 -server_admin_pw 0000 -objects pak.nippon -log 1 -debug 2 -lang ja -singleuser -load ../hogehoge.sve これらのライブラリを入れると当然ながらヘッドレスではなくなるので、configureしたときの表記がWARNING: No backend found, using server (posix)!からWARNING: Using SDL2 backend!になります。要検証ですがバックエンドがSDL2になってもヘッドレスで動いているため、多分サーバーの動作には影響がない…はず？（環境がUbuntu Serverなのでたまたまいけてるのかも）\nsudo docker run -d -p 13353:13353 -p 6080:6080 --restart=always --name hoge -v [アドオンのフォルダのパス]:/app/pak.nippon -v [任意のパス（Discord Botコンテナとcmd.txtなどをやりとりするため）]:/app/file_io --log-opt max-size=100m --log-opt max-file=5 simutrans-server:v46 このDockerfileのコンテナを立ち上げるときのコマンドは以上のとおり。NoVNCを実行するため6080番も開けていますね。このコマンドを実行するときは、同じディレクトリにstart.shなどのファイル群やSimutrans World Monitorの中身であるsqai_hm_monitorフォルダ、セーブデータとしてsave.sveを据えておく必要があります。\nここで、セーブデータもアドオンのようにマウントすればやり取りが楽になると思った方もいると思いますが、私の環境だとセーブデータをマウントすると以下の動画のようにNSに誰かが入ると先に入ってた人が切断されてしまいました。\nお使いのブラウザは動画タグをサポートしていません。 ただし、save.shでセーブデータが保存されるフォルダ（/app/autosave）はホストのどこかにマウントしておくべきなので、このコマンドも要修正ものです。\nなお、sqai_hm_monitor/libs/global.nutの各ファイルのパスは本稿の環境では\"/app/file_io/cmd.txt\"などのように変更しないとAIプレイヤー追加時にエラーとなります。\nDocker Composeを使えばほかのコンテナと併せてデータのやり取りが楽になりそうですが、docker-compose,ymlはitzg/docker-minecraft-serverでちょっと触ったくらいの知識しかないのでまだ勉強中です。また、あるときからNS内のログを取るようにしたところサーバー機のストレージ全体がログファイルで溢れかけたので、ログファイルは最大500MB（100MBで区切って5個まで保持）となるようにしています。\n以上でヘッドレスOTRPのコンテナを作ることができました。ここからは、コマンドにてマウントしてるfile_ioフォルダとファイルのやり取りをするSimutrans World MonitorのDiscord Botのコンテナを用意します。\nDiscord Botのコンテナ Dockerfile（生成AI製だったはず　なぜgitを入れてるか分からない） FROM python:3.11-slim # 必要なパッケージをインストール RUN apt-get update \u0026\u0026 apt-get install -y \\ git \\ \u0026\u0026 rm -rf /var/lib/apt/lists/* # 作業ディレクトリを設定 WORKDIR /app # requirements.txt をコピーして依存関係をインストール COPY requirements.txt ./ RUN pip install --no-cache-dir -r requirements.txt # Botのソースコードをコピー COPY . . # Botの起動コマンド CMD [\"python\", \"monitor.py\"] monitor.py（加筆した部分のみ） ALLOWED_CHANNELS = [1234567891234657891,1234567891234657891] ALLOWED_TYPES = ['.tab','.pak','.zip'] SAVE_DIR = '/app/data' intents = discord.Intents.default() # デフォルトのインテントを使う intents.message_content = True client = discord.Client(intents=intents) tree = app_commands.CommandTree(client) GUILD_ID = 1234567891234567891 @tree.command(name=\"nurupo\", description=\"駅員が反応します。\", guild=discord.Object(id=GUILD_ID)) async def ping(interaction: discord.Interaction): if interaction.channel_id not in ALLOWED_CHANNELS: await interaction.response.send_message( \"コマンドは指定のチャンネルでの呼び出しをお願いします。\", ephemeral=True ) return await interaction.response.send_message(\"ガッ\") @tree.command(name=\"download_sve\", description=\"最新のセーブデータを送信します。データは毎時5分・45分更新です。\", guild=discord.Object(id=GUILD_ID)) async def download_sve(interaction: discord.Interaction): if interaction.channel_id not in ALLOWED_CHANNELS: await interaction.response.send_message( \"コマンドは指定のチャンネルでの呼び出しをお願いします。\", ephemeral=True ) return await interaction.response.defer() autosave_dir = Path(\"/app/autosave\") sve_files = list(autosave_dir.glob(\"*.sve\")) latest_file = max(sve_files, key=lambda f: f.stat().st_mtime) await interaction.followup.send(file=discord.File(latest_file)) # メッセージ受信時に動作する処理 @client.event async def on_message(message): # メッセージ送信者がBotだった場合は無視する if message.author.bot: return if not message.channel.id in ALLOWED_CHANNELS: return if message.attachments: for attachment in message.attachments: file = attachment.filename if any(file.lower().endswith(ext) for ext in ALLOWED_TYPES): # ファイルを保存 save_path = os.path.join(SAVE_DIR, file) await attachment.save(save_path) print(f\"{file} を保存しました。\") await message.add_reaction(\"👍\") コンテナの立ち上げコマンドは次のとおり。\nsudo docker run -d --restart=always --name discord-bot -v [任意のパス（Discord Botコンテナとcmd.txtなどをやりとりするため）]:/app/file_io -v [受け取ったpakファイルを置く場所]:/app/data discord-bot:latest Simutrans Wolrd Monitorを使用していると（要検証）、クライアント側に保存されるclient-network.sveのようなセーブデータがローカルで開けなくなる現象があり、サーバー側のオートセーブを持ってきて投稿するスラッシュコマンドをこさえていますが、セーブデータがDiscordの容量制限のせいで投稿できないため凍結されています。\nまた、リポジトリのreadmeではSimutransとDiscord Botの起動順序の言及がありますが、私の環境ではどちらが先でも動いてくれました。\nアドオン追加・更新を自動化 以下のスクリプト類は生成AIの力を借りて突貫で作成したもののため、「こうやってるのがあるらしい」と生成AIに投げるために使う程度に留めたほうがよいです。\nnginxのwebサーバー docker-compose.yaml version: '3.8' services: nginx: image: nginx:stable-alpine container_name: simutrans_web_server ports: - \"8080:80\" volumes: - [任意のフォルダ]:/usr/share/nginx/html/pak_update:ro restart: always このwebサーバーをtailscale funnelで公開します（コマンドは書きとめてなかったようです）。\n参加者に実行してもらうスクリプト setup.bat（OTRPのバージョン確認が欠陥） @echo off cd /d \"%~dp0\" set SIMUTRANS_VER=122-0 set OTRP_VER=v44_3 set OUTPUT_FILE=simuwin-%SIMUTRANS_VER%.zip set OTRP_OUTPUT_FILE=sim-WinGDI64-OTRP%OTRP_VER%.zip echo simutransをセットアップします if not exist simutrans.exe ( echo simutransをダウンロードします curl -L -o \"%OUTPUT_FILE%\" \"https://sourceforge.net/projects/simutrans/files/simutrans/%SIMUTRANS_VER%/simuwin-%SIMUTRANS_VER%.zip/download\" powershell -Command \"Expand-Archive -Path '%OUTPUT_FILE%' -DestinationPath '.' -Force\" robocopy simutrans . /E /MOVE rmdir simutrans del %OUTPUT_FILE% echo simutransのセットアップが完了しました ) else ( echo simutransのセットアップは完了しています ) echo. echo OTRPをセットアップします if not exist sim-WinGDI64-OTRPv44_3.exe ( echo OTRP %OTRP_VER% をダウンロードします curl -L -o \"%OTRP_OUTPUT_FILE%\" \"https://github.com/teamhimeh/simutrans/releases/download/%OTRP_VER%/sim-WinGDI64-OTRP%OTRP_VER%.zip\" powershell -Command \"Expand-Archive -Path '%OTRP_OUTPUT_FILE%' -DestinationPath '.' -Force\" del %OTRP_OUTPUT_FILE% echo OTRPのセットアップが完了しました ) else ( echo OTRPのセットアップは完了しています ) echo. echo セットアップが完了しました echo 続いて、simutrans-updater.batを実行してpakファイルをダウンロードしてください。 pause simutrans-updater.bat @echo off REM ここに起動したいsimutransのファイル名を書く（例：simutrans.exe、sim-WinGDI64-OTRPv44_3.exeなど） set SIMUTRANS_PATH=sim-WinGDI64-OTRPv44_3.exe set PAK_FOLDER=pak set VERSION_URL=https://hoge.tail123abc.ts.net/pak_update/pakversion.txt set ZIP_URL=https://hoge.tail123abc.ts.net/pak_update/release.zip cd /d \"%~dp0\" REM exeの存在確認 if not exist \"%SIMUTRANS_PATH%\" ( echo 実行ファイル %SIMUTRANS_PATH% が見つかりません。batファイルをメモ帳で開き、SIMUTRANS_PATHに起動したいsimutransのファイル名を書いてください（例：simutrans.exe、sim-WinGDI64-OTRPv44_3.exeなど） pause exit /b ) REM ローカルのpakversionの存在確認 echo ローカルのバージョンを確認しています set LOCAL_VER=0 if exist pakversion.txt ( set /p LOCAL_VER=\u003cpakversion.txt ) echo %LOCAL_VER% REM webサーバー上のバージョン取得 echo 更新情報を読み込みます curl -s %VERSION_URL% \u003e pakversion.tmp set /p WEB_VER=\u003cpakversion.tmp del pakversion.tmp echo %WEB_VER% set /a LOCAL_NUM=%LOCAL_VER% set /a WEB_NUM=%WEB_VER% if %LOCAL_NUM% GEQ %WEB_NUM% ( echo ローカルのバージョンは最新です ) else ( echo 新しいバージョンが存在します。pakの更新をしています... if exist \"%PAK_FOLDER%\" ( rmdir /s /q \"%PAK_FOLDER%\" ) powershell -Command \"(New-Object System.Net.WebClient).DownloadFile('%ZIP_URL%', 'release.zip')\" powershell -Command \"Expand-Archive -Path 'release.zip' -DestinationPath '.' -Force\" del release.zip \u003e pakversion.txt echo %WEB_VER% echo アップデートが完了しました ) echo ゲームを起動します start \"\" \"%SIMUTRANS_PATH%\" -objects \"%PAK_FOLDER%\" アドオンを追加する側の動作 やってることは先駆者様と同じでほぼ真似てるといえるのでアドオンをリポジトリで管理しています。ただGithub Actionがうまくいかず追加手順は手動です。\n更新手順（Windows環境） git add . git commit -m \"変更点をここに書く\" git tag -a 20251217 -m \"追加分\" git push origin --tags after_push.bat @echo off chcp 65001 \u003enul set \"MAKEOBJ_PATH=...\\makeobj-win-60-7\\makeobj.exe\" cd /d \"%~dp0\" REM Gitリポジトリか確認 git rev-parse --is-inside-work-tree \u003enul 2\u003e\u00261 if errorlevel 1 ( echo このフォルダはGitリポジトリではありません。 pause exit /b 1 ) REM 最新コミットに付いているタグを取得（なければ空） for /f \"delims=\" %%T in ('git tag --points-at HEAD') do ( echo %%T \u003e pakversion.txt goto :done ) REM タグが無ければファイル作成せず通知（必要なら空ファイルを作ってもよい） echo 最新のコミットにはタグが付いていません。 goto :eof :done echo 最新のタグを pakversion.txt に出力しました。 type pakversion.txt if exist \"release\" ( echo release フォルダを空にします。 del /q /f \"release\\*\" for /d %%D in (\"release\\*\") do rd /s /q \"%%D\" echo 完了しました！ ) else ( echo release フォルダが見つかりません。 ) REM pakフォルダを作成 if not exist \"release\\pak\" mkdir \"release\\pak\" REM ground.Outsideを移動してmerge、その他もろもろをコピー copy /Y \"pak-data\\ground.Outside.pak\" \"release\\pak\\\" \"%MAKEOBJ_PATH%\" merge \"release\\pak\\boot.pak\" \"pak-data\\*.pak\" robocopy \"pak-data\" \"release\\pak\" /E /XF *.pak REM PowerShellのCompress-Archiveを使ってzipに powershell -Command \"Compress-Archive -Path 'release\\*' -DestinationPath 'release.zip' -Force\" REM scpでzipとpakversionをwebサーバーに配置 scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \"release.zip\" [サーバー機のWebサーバーのパス] if %ERRORLEVEL% EQU 0 ( echo SCP転送成功 ) else ( echo SCP転送失敗 エラーコード: %ERRORLEVEL% ) scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \"pakversion.txt\" [サーバー機のWebサーバーのパス] if %ERRORLEVEL% EQU 0 ( echo SCP転送成功 ) else ( echo SCP転送失敗 エラーコード: %ERRORLEVEL% ) REM sshでpakフォルダの中身を消してscpで新しいpakフォルダの中身を転送してくる ssh \"rm -rf [サーバー機のアドオンフォルダ]\" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -r \"release\\pak\\.\" [サーバー機のWebサーバーのパス] REM dockerコンテナの再起動 ssh \"sudo docker restart hoge\" pause おわりに いかがでしたか？\n後半は息絶えてますが、こんな感じでNSを立てると冒頭に触れた機能を持ったサーバーができます。Dockerfileもそのまま使えるかは怪しいのであまり役に立たない記事ですが、あなたの鯖立てに少しでも貢献できていたら嬉しいです。\nさいごに、1週間の大遅刻となってしまいすみませんでした……。\nそれではよいSimutransライフを！\n","wordCount":"1250","inLanguage":"ja","image":"https://www.araduke.net/maguro.png","datePublished":"2025-12-26T01:31:53+09:00","dateModified":"2025-12-26T01:31:53+09:00","author":{"@type":"Person","name":"Simutrans Advent Calendar 2025 17日目"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.araduke.net/posts/251217/"},"publisher":{"@type":"Organization","name":"漬けなくてもおいしい","logo":{"@type":"ImageObject","url":"https://www.araduke.net/sushi64x64.png"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://www.araduke.net/ accesskey=h title="Home (Alt + H)"><img src=https://www.araduke.net/sushi64x64.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.araduke.net/profile title=Profile><span>Profile</span></a></li><li><a href=https://www.araduke.net/archives title=Archive><span>Archive</span></a></li><li><a href=https://www.araduke.net/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.araduke.net/>ホーム</a>&nbsp;»&nbsp;<a href=https://www.araduke.net/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">NSや周辺サービスをDockerで構築するときの備忘録</h1><div class=post-description>あるいはどんなネット環境の人でもNSを立てることができる最強のフローチャート</div><div class=post-meta><span title='2025-12-26 01:31:53 +0900 +0900'>2025年12月26日 01:31</span>&nbsp;·&nbsp;<span>Simutrans Advent Calendar 2025 17日目</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目次</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#質問に答えるだけでnsが立つフローチャート>質問に答えるだけでNSが立つフローチャート</a><ul><li><a href=#質問１サーバーとして使える物理pcとネット環境はありますか>質問１　サーバーとして使える物理PCとネット環境はありますか？</a></li><li><a href=#質問２ポート開放はできますか>質問２　ポート開放はできますか？</a></li><li><a href=#質問３ネットの接続方法はipoeですか>質問３　ネットの接続方法はIPoEですか？</a></li><li><a href=#ポート開放できないときの選択肢すなわち最も安全な択>ポート開放できないときの選択肢　すなわち最も安全な択</a></li></ul></li><li><a href=#いずれかの方法を取れば無料で一部除くnsが立てられます今日からあなたも鯖主です>いずれかの方法を取れば無料で（一部除く）NSが立てられます！　今日からあなたも鯖主です！！！！</a></li><li><a href=#公式wiki以外のすべてを疑え>公式wiki以外のすべてを疑え</a></li><li><a href=#dockerコンテナなんもわからんでも使ったほうがいい>Dockerコンテナなんもわからん　でも使ったほうがいい</a><ul><li></li></ul></li><li><a href=#discord-botのコンテナ>Discord Botのコンテナ</a><ul><li></li></ul></li><li><a href=#アドオン追加更新を自動化>アドオン追加・更新を自動化</a><ul><li><a href=#nginxのwebサーバー>nginxのwebサーバー</a></li><li><a href=#参加者に実行してもらうスクリプト>参加者に実行してもらうスクリプト</a></li><li><a href=#アドオンを追加する側の動作>アドオンを追加する側の動作</a></li></ul></li><li><a href=#おわりに>おわりに</a></li></ul></nav></div></details></div><div class=post-content><p>この記事は<a href=https://adventar.org/calendars/11306>Simutrans Advent Calendar 2025</a>の17日目のものです。</p><div class=iframe-wrapper style="margin:1rem 0;text-align:center"><iframe src=https://adventar.org/calendars/11306/embed width=100% height=362 title="External Content" style="border:0;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.1)" allowfullscreen loading=lazy referrerpolicy=no-referrer-when-downgrade></iframe></div><h2 id=はじめに>はじめに<a hidden class=anchor aria-hidden=true href=#はじめに>#</a></h2><p>Netsimutrans（以下NS）はさまざまな方法で構築でき、この大遅刻記事が参加しているSimutrans Advent Calendar 2025に限ってもWindows環境×ポート開放、ポート開放不要、Linux環境（Extended）など、OS・Simutransの種類・インターネットへの公開方法の組み合わせがそれぞれ異なる構築方法が紹介されています。</p><p>本稿ではLinuxでDockerを使い、ヘッドレスOTRP・Discord Bot・nginxを動かすことで、<a href=https://github.com/teamhimeh/simutrans_world_monitor>Simutrans World Monitor</a>が使えてアドオン追加はDiscordサーバーにPakファイルを投げて更新はbatファイルを叩いて待っていれば済むNSの構築の仕方を話していきます。</p><p>ヘッドレスなOTRPとアドオン追加・更新の自動化はそれぞれ詳しい記事がすでに存在するのですが、環境など細かいところが異なっているので改めて取り上げたいと思います。</p><p>…こういう考えの人がいるせいで、個別具体的な記事が増えていくのでしょう。そこで本稿では個別具体的でない記事ということをアピールするためはじめにNSのインターネットへの公開方法を一通りまとめてみました。</p><h2 id=質問に答えるだけでnsが立つフローチャート>質問に答えるだけでNSが立つフローチャート<a hidden class=anchor aria-hidden=true href=#質問に答えるだけでnsが立つフローチャート>#</a></h2><ul><li>質問１　サーバーとして使える物理PCとネット環境はありますか？<ul><li>はい：質問２へ</li><li>いいえ：VPSサーバーを契約しましょう</li></ul></li><li>質問２　ポート開放はできますか？<ul><li>はい：お好きな番号を開放しましょう</li><li>いいえ・分からない：質問３へ</li></ul></li><li>質問３　ネットの接続方法はIPoE（IPv4 over IPv6やMAP-E、OCNバーチャルコネクトやv6プラスみたいな名前）ですか？<ul><li>はい：利用可能ポート番号の範囲から解放しましょう</li><li>いいえ：以下のどちらかを選んでください<ul><li>GCEの無料枠でVPNサーバーを立てる<ul><li>［デメリット］レイテンシ（遅延）が増える</li></ul></li><li>参加者にCloudflaredかTailscaleを入れてもらう<ul><li>［デメリット］入れてもらう手間・申し訳なさの発生</li></ul></li></ul></li></ul></li></ul><h3 id=質問１サーバーとして使える物理pcとネット環境はありますか>質問１　サーバーとして使える物理PCとネット環境はありますか？<a hidden class=anchor aria-hidden=true href=#質問１サーバーとして使える物理pcとネット環境はありますか>#</a></h3><p>NSをしたい期間（24時間365日かもしれないし、毎週土曜朝に起動して日曜夜に落とすだけで事足りるかもしれない）に起動し続けられるPCとネット環境さえあれば、NSは無料で立てることができます。</p><p>ポート開放によるリスクを度外視すれば、ポートが開けられないだけでは財布を開こうとしなくていいのです。</p><p>なお、2.4GHzのWi-Fiでネットに繋げているために親が電子レンジを使うと通信が切れるのならルーターから有線で繋げられる位置にPCを移動し、雷雲が近づくと親がルーターのコンセントごと引っこ抜いてしまうのなら説得してやめてもらいましょう。</p><p>居住形態によってこんな風に立ちはだかる大小の壁を乗り越えられなさそうであれば、以下の記事のようにVPSサーバーを借りてNSを立てることになります。</p><ul><li>この手順で参考になる記事<ul><li><a href="https://ahozura.kasu.me/portal/?p=2195">【令和最新版】「世界一快適なNS」を目指して【Simutrans Advent Calendar 2022】 - AhozuraNS Simutrans Laboratory</a></li><li>アドカレ最終日の記事（おそらく）→　<a href=https://nain-simutranser-site.hatenablog.jp/entry/2025/12/25/010636>NS鯖をAWSで立てたらおいくら万円かかんねんアメカス守銭奴SP【Simutrans Advent Calendar 2025 | 25日目】 - Nain-simutransRoom</a></li></ul></li></ul><h3 id=質問２ポート開放はできますか>質問２　ポート開放はできますか？<a hidden class=anchor aria-hidden=true href=#質問２ポート開放はできますか>#</a></h3><p>ポート開放が可能ならもはや言うことはありませんが、セキュリティリスクを考えると<del>13353番が有名なポート番号かどうかは置いておいて</del>別の番号を開放し、参加者にはポート番号付きのサーバーアドレスを打ってもらう方がいいかもしれません。</p><p>またいずれも後述しますが、レイテンシ（遅延）を受け入れるのならVPNを立てる、あるいは参加者に別途ソフトを入れてもらい家の物理PCはポート開放しないでおくのが一番安全といえます。</p><ul><li>この手順で参考になる記事<ul><li><a href=https://sites.google.com/site/ahakuoku/blog/20>ahakuokuのHP - サルでもわかるNS運営</a></li></ul></li></ul><h3 id=質問３ネットの接続方法はipoeですか>質問３　ネットの接続方法はIPoEですか？<a hidden class=anchor aria-hidden=true href=#質問３ネットの接続方法はipoeですか>#</a></h3><p>まずネットの接続方法は<a href=https://v6test.ocn.ne.jp/>このサイト（OCN IPoE接続環境確認サイト）</a>か、ルーターの設定画面、最悪プロバイダーとの契約書で確認できます。IPoEやIPv4 over IPv6などとあれば、ルーターの設定画面や<a href=https://isecj.jp/tools/portcheck-map-e/>このサイト（IPv6(MAP-E方式)使用可能ポート確認）</a>で確認できる利用可能ポート番号の中でポート開放ができます。</p><p>利用可能ポート番号に13353が含まれていることは稀なので、上述したようにサーバーアドレスはポート番号付きになるほか、IPoEでもDS-Liteというものだった場合ポート開放ができません。</p><p>これは、IPoEという接続方法は普通の方法（PPPoEという）と違いグローバルIPv4アドレスをほかのユーザーと共有しており、MAP-Eという方式ではそのアドレスのポート番号のうちいくつかが利用可能ポートとして割り当てられるのに対し、DS-Liteでは割り当てられないためです。</p><figure><img loading=lazy src=/251217_1.jpg><figcaption>NECのルーターではホーム>情報>現在の状態の下の方に利用可能ポート一覧がある</figcaption></figure><p>あとは普通にポート開放ができる場合と手順は同じです。</p><h3 id=ポート開放できないときの選択肢すなわち最も安全な択>ポート開放できないときの選択肢　すなわち最も安全な択<a hidden class=anchor aria-hidden=true href=#ポート開放できないときの選択肢すなわち最も安全な択>#</a></h3><p>DS-Lite方式でネットに繋いでいるなどでポート開放ができない場合、またセキュリティリスクを考えるとNSの立てるには以下の選択肢が残ります。いずれも無料なのでNSを立てないという道はありません。</p><h4 id=gceの無料枠でvpnサーバーを立てる>GCEの無料枠でVPNサーバーを立てる<a hidden class=anchor aria-hidden=true href=#gceの無料枠でvpnサーバーを立てる>#</a></h4><p>Googleのクラウドサービス Google CloudのCompute Engineには<a href="https://docs.cloud.google.com/free/docs/free-cloud-features?hl=ja#compute">無料枠</a>があり、2025年現在米国リージョンのe2-micro（一番低いスペック）インスタンスおよび外部IPv4アドレスを永続的に無料で利用できます。</p><p>無料枠のインスタンスをVPSサーバーとして使うのは無理がありますが、IPv4アドレスが付いてくるのでここで通信を受け取り、自宅PCに転送するVPNサーバー、いわゆる踏み台サーバーとして使うことができます。</p><p>ポート開放が不要で、VPNサーバーと自宅PCとの通信はTailscaleやZeroTierなどですればポート開放するよりもセキュリティリスクは数倍低くなります。</p><p>問題はNSと参加者双方が日本に居てもVPNサーバーを経由、すなわち太平洋を往復しながら通信するためレイテンシ（遅延）が増えてしまうことで、リージョンを日本に変更すると月額課金が発生してしまうことです。</p><p>私はこの方法で身内マイクラ鯖を動かしていましたが、日本リージョンにしてから月あたり1000円前後が持っていかれていました。</p><p>この方法でNSを立てている記事がないためマイクラ鯖の例となりますが、動かすゲームが違うだけで同じTCP通信なので参考にはできると思います。遅延のなかでのSimutransの操作感は分かりませんが。</p><ul><li>この手順で参考になる記事<ul><li><a href=https://note.com/yayoi_8128/n/n4a35f271a57f>GCPの無料枠で作ったVPSを通してマイクラ自宅サーバーを公開する | やよい.⁸⁴¹</a></li></ul></li></ul><h4 id=参加者にcloudflaredかtailscaleを入れてもらう>参加者にCloudflaredかTailscaleを入れてもらう<a hidden class=anchor aria-hidden=true href=#参加者にcloudflaredかtailscaleを入れてもらう>#</a></h4><p>最終手段かつ最も安全な方法といえるのがこれで、Cloudflare TunnelではNSと参加者間に通信のトンネルを作り、Tailscaleでは仮想ネットワーク内でNSと参加者が通信する形で、サーバー側のポート開放なしでNSが実現できます。いずれも参加者にはCloudflaredかTailscaleアプリを入れてもらわないといけません。</p><p>Cloudflareでは独自ドメインが必要なうえ、接続するためにコマンドプロントなどでコマンドを打ってもらう必要がありますが、Tailscaleではサーバー機の共有リンクを踏んでもらえば、以降はサーバー機のTailscale上のIPアドレスを入れるだけで接続が可能です（Tailscaleが裏で起動してる必要はあり）。</p><p>なお、Tailscaleの共有はネットワーク丸ごと共有するのと各マシンを共有するの（Node Sharing）の2つがあり、前者は無料プランだと共有できる人数が3ユーザーまでなのですが、NSをやるにあたってはNode Sharingで十分なはずです。</p><ul><li>この手順で参考になる記事<ul><li>Cloudflare<ul><li><a href="https://ahozura.kasu.me/portal/?p=6247">CloudflareTunnelでポート開放不要のNetSimutransを楽しもう！【Simutrans Advent Calender 2025】 - AhozuraNS Simutrans Laboratory</a></li></ul></li><li>Tailscale（Minecraftだけど）<ul><li><a href=https://qiita.com/harunn/items/02069a660361a2225525>tailscale を用いた Minecraft サーバー接続 (ACL制御) [TrueNAS] #Minecraft - Qiita</a></li></ul></li></ul></li></ul><h2 id=いずれかの方法を取れば無料で一部除くnsが立てられます今日からあなたも鯖主です>いずれかの方法を取れば無料で（一部除く）NSが立てられます！　今日からあなたも鯖主です！！！！<a hidden class=anchor aria-hidden=true href=#いずれかの方法を取れば無料で一部除くnsが立てられます今日からあなたも鯖主です>#</a></h2><h2 id=公式wiki以外のすべてを疑え>公式wiki以外のすべてを疑え<a hidden class=anchor aria-hidden=true href=#公式wiki以外のすべてを疑え>#</a></h2><p>いよいよ本題のヘッドレスOTRPのビルドに移りますが、冒頭で触れたようにDockerでのビルドは先駆者様がいます。</p><p><a href=https://qiita.com/YutaGameMusic/items/f8f3e6f89290e5a2e9d1>Simutrans OTRPのHeadlessサーバーを建てるのに苦労した話 #game - Qiita</a></p><p>ではこの記事を見ればよいですね。解散！</p><p>…とはいきません。見出しに書いてあることを読んでもらいたいのですが、2025年現在のLinux環境でのビルドではconfig.defaultを書き換える必要はなくなっているため、ネット上に数多くあるビルド方法のほぼすべては過去のものといえるのです（日本語wikiの記載変えたほうがよくない？）。</p><p>そのため、先駆者様の記事も疑ってみましょう。<a href="https://simutrans-germany.com/wiki/wiki/en_CompilingSimutrans?page_ref_id=501">公式Wikiのビルド方法</a>によると、makeでのビルドは必要なライブラリを入れた後に</p><pre><code>autoconf
./configure
make -j $(nproc)
</code></pre><p>と打てばビルドに進めるようです。なお、実際にはautoconfを実行すると</p><pre><code>configure.ac:175: warning: AC_OUTPUT should be used without arguments.
configure.ac:175: You should run autoupdate.
</code></pre><p>と言われるのでautoupdateをしてからのautoconfとなります。</p><p>ところが同記事のDockerfileではmakeの前にしているのは<code>autoconf /simutrans/configure.ac</code>（autoconfで付けられた実行権限でconfigureを叩く場面のところ、叩いてるのはconfigure.acだし、autoconfは引数なしで動くはず）のみで、別途sedコマンドなどでconfig.defaultの書き換えもしてないようです。そのため、makeしても</p><pre><code>Makefile:34: *** Unkown BACKEND &quot;&quot;, must be one of &quot;gdi sdl sdl2 mixer_sdl mixer_sdl2 posix&quot;.  Stop.
</code></pre><p>というおそらくSimutransのビルドに挑戦した人が最も多く見るであろうエラーが返されます。</p><p>人様の記事を疑ったので、この記事も疑ってみましょう。buildできないDockerfileのままで良しとする人はそんなに存在しないと考えられるため、この記事ではうそを言って先駆者様の記事を貶してるといえます。</p><p>そこで、以下にこの記事においてちゃんと動くと主張されているDockerfileを示しますので、先駆者様のDockerfileと併せて</p><pre><code>docker run -dit ubuntu:latest
docker exec -it (コンテナ名orID)
</code></pre><p>して、それぞれの内容を実行してみてmakeが通るか試してみてください。</p><p>ちなみに、Windows環境ではSimutransのexeファイルをサーバーモードで実行すればソースコードからビルドという七面倒な手順を踏まずにNSを立てれるので、Linux環境でもできないかとOTRPのReleaseから最新の実行ファイルを取ってきました。以下のDockerfileなどで動作中のNSのファイル群に置いてビルドしたsimの代わりに実行してみると、</p><pre><code>./sim-linux-OTRPv48_2: error while loading shared libraries: libminiupnpc.so.17: cannot open shared object file: No such file or directory
</code></pre><p>よく分からないのですがダメみたいです。</p><h2 id=dockerコンテナなんもわからんでも使ったほうがいい>Dockerコンテナなんもわからん　でも使ったほうがいい<a hidden class=anchor aria-hidden=true href=#dockerコンテナなんもわからんでも使ったほうがいい>#</a></h2><p>NSの実行では<a href=https://7ka.org/netsimutrans-server-linux/>systemd</a>や<a href="https://ahozura.kasu.me/portal/?p=2195">nohup</a>などでずっと実行されているようにすることが大切ですが、<a href="https://forum.simutrans.com/index.php?topic=20269.0">たった5MBの実行ファイルのためだけにDocker使うんですか？？？（意訳）</a>の声を跳ねのけてDockerを使いましょう。アドオンフォルダやセーブデータを適切に管理しておけば、本体バージョンのアップデートなどが簡単に行えます。</p><h4 id=dockerfile>Dockerfile<a hidden class=anchor aria-hidden=true href=#dockerfile>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=w> </span><span class=s>ubuntu:latest</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>ARG</span> SIMUTRANS_VERSION<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># SIMUTRANS_VERSIONが設定されていない場合はビルドを失敗させる</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> <span class=k>if</span> <span class=o>[</span> -z <span class=s2>&#34;</span><span class=si>${</span><span class=nv>SIMUTRANS_VERSION</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span> <span class=se>\
</span></span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Error: SIMUTRANS_VERSION build argument is not set. Please use --build-arg SIMUTRANS_VERSION=&lt;version&gt;.&#34;</span><span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>        <span class=nb>exit</span> 1<span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    <span class=k>fi</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>SIMUTRANS_VERSION</span><span class=o>=</span><span class=si>${</span><span class=nv>SIMUTRANS_VERSION</span><span class=si>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 必要なパッケージのインストール</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> apt-get install -y <span class=se>\
</span></span></span><span class=line><span class=cl>    wget unzip autoconf zstd make gcc g++ <span class=se>\
</span></span></span><span class=line><span class=cl>    zlib1g-dev libbz2-dev libpng-dev cron curl vim <span class=se>\
</span></span></span><span class=line><span class=cl>    libsdl2-dev xvfb x11vnc websockify python3-websockify novnc fluxbox<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># simutransのソースコードのダウンロード、展開</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=w> </span><span class=s>/tmp</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> wget <span class=s2>&#34;https://github.com/teamhimeh/simutrans/archive/refs/tags/</span><span class=si>${</span><span class=nv>SIMUTRANS_VERSION</span><span class=si>}</span><span class=s2>.zip&#34;</span> <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    unzip <span class=s2>&#34;</span><span class=si>${</span><span class=nv>SIMUTRANS_VERSION</span><span class=si>}</span><span class=s2>.zip&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># Simutransのビルドディレクトリに移動</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># v44_3.zip が simutrans-44_3/ に展開されることを想定し、</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># ${SIMUTRANS_VERSION#v} を使って動的にパスを生成</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=w> </span><span class=s>&#34;/tmp/simutrans-${SIMUTRANS_VERSION#v</span><span class=o>}</span><span class=s2>&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> autoupdate <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    autoconf <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    ./configure <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    make <span class=nv>DEBUG</span><span class=o>=</span><span class=m>1</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># nettoolsのビルド</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=w> </span><span class=s>&#34;/tmp/simutrans-${SIMUTRANS_VERSION#v}/nettools</span><span class=s2>&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> make<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># get_lang_files.sh の実行とtextフォルダの取得</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=w> </span><span class=s>&#34;/tmp/simutrans-${SIMUTRANS_VERSION#v</span><span class=o>}</span><span class=s2>&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> ./get_lang_files.sh<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 最終的なディレクトリを用意</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=w> </span><span class=s>/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 1. sim実行ファイルのコピー</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> cp <span class=s2>&#34;/tmp/simutrans-</span><span class=si>${</span><span class=nv>SIMUTRANS_VERSION</span><span class=p>#v</span><span class=si>}</span><span class=s2>/sim&#34;</span> .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 2. nettoolsフォルダ全体のコピー</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> cp -r <span class=s2>&#34;/tmp/simutrans-</span><span class=si>${</span><span class=nv>SIMUTRANS_VERSION</span><span class=p>#v</span><span class=si>}</span><span class=s2>/nettools&#34;</span> .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 3. textフォルダのコピー（実行ファイルと同じ階層へ）</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> cp -r <span class=s2>&#34;/tmp/simutrans-</span><span class=si>${</span><span class=nv>SIMUTRANS_VERSION</span><span class=p>#v</span><span class=si>}</span><span class=s2>/simutrans/text&#34;</span> /app/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> cp -r <span class=s2>&#34;/tmp/simutrans-</span><span class=si>${</span><span class=nv>SIMUTRANS_VERSION</span><span class=p>#v</span><span class=si>}</span><span class=s2>/simutrans/font&#34;</span> /app/<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> cp -r <span class=s2>&#34;/tmp/simutrans-</span><span class=si>${</span><span class=nv>SIMUTRANS_VERSION</span><span class=p>#v</span><span class=si>}</span><span class=s2>/simutrans/themes&#34;</span> /app/<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> cp -r <span class=s2>&#34;/tmp/simutrans-</span><span class=si>${</span><span class=nv>SIMUTRANS_VERSION</span><span class=p>#v</span><span class=si>}</span><span class=s2>/simutrans/script&#34;</span> /app/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> save.sve /app/server13353-network.sve<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> sqai_hm_monitor /app/ai/sqai_hm_monitor/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> start.sh /app/start.sh<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> savecron /app/savecron<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> save.sh /app/save.sh<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> chmod +x /app/start.sh /app/save.sh<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># ビルド成果物を除いた中間ファイルを削除</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> rm -rf /tmp/*<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># コンテナ起動時に実行するコマンド</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;/app/start.sh&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></div><h4 id=startsh>start.sh<a hidden class=anchor aria-hidden=true href=#startsh>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>set</span> -e
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /app
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>crontab /app/savecron
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cron
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/app/sim -server <span class=m>13353</span> -server_admin_pw <span class=m>0000</span> -objects pak.nippon -log <span class=m>1</span> -debug <span class=m>4</span> -lang ja -singleuser -load ../server13353-network.sve
</span></span></code></pre></div><h4 id=savesh>save.sh<a hidden class=anchor aria-hidden=true href=#savesh>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>SAVE_DIR</span><span class=o>=</span><span class=s2>&#34;/app/autosave&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>SAVE_FILE</span><span class=o>=</span><span class=s2>&#34;/app/server13353-network.sve&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>NETTOOL</span><span class=o>=</span><span class=s2>&#34;/app/nettools/nettool&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mkdir -p <span class=s2>&#34;</span><span class=nv>$SAVE_DIR</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[</span><span class=k>$(</span>date <span class=s1>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class=k>)</span><span class=s2>] save.sh started&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;</span><span class=nv>$NETTOOL</span><span class=s2>&#34;</span> -p <span class=m>0000</span> say <span class=s2>&#34;10秒後に自動セーブを行います。&#34;</span>
</span></span><span class=line><span class=cl>sleep <span class=m>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;</span><span class=nv>$NETTOOL</span><span class=s2>&#34;</span> -p <span class=m>0000</span> force-sync
</span></span><span class=line><span class=cl>sleep <span class=m>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp <span class=s2>&#34;</span><span class=nv>$SAVE_FILE</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$SAVE_DIR</span><span class=s2>/</span><span class=k>$(</span>date <span class=s1>&#39;+%Y%m%d-%H%M&#39;</span><span class=k>)</span><span class=s2>.sve&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#sveファイルが100個より多くなったら1個消す</span>
</span></span><span class=line><span class=cl><span class=nv>file_count</span><span class=o>=</span><span class=k>$(</span>find <span class=s2>&#34;</span><span class=nv>$SAVE_DIR</span><span class=s2>&#34;</span> -maxdepth <span class=m>1</span> -type f -name <span class=s1>&#39;*.sve&#39;</span> <span class=p>|</span> wc -l<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$file_count</span><span class=s2>&#34;</span> -gt <span class=m>100</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nv>old_file</span><span class=o>=</span><span class=k>$(</span>find <span class=s2>&#34;</span><span class=nv>$SAVE_DIR</span><span class=s2>&#34;</span> -maxdepth <span class=m>1</span> -type f -name <span class=s1>&#39;*.sve&#39;</span> -printf <span class=s1>&#39;%T@ %p\n&#39;</span> <span class=p>|</span> sort -n <span class=p>|</span> head -n <span class=m>1</span> <span class=p>|</span> awk <span class=s1>&#39;{print $2}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$old_file</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        rm -v <span class=s2>&#34;</span><span class=nv>$old_file</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></div><h4 id=savecron>savecron<a hidden class=anchor aria-hidden=true href=#savecron>#</a></h4><pre><code>*/30 * * * * /app/save.sh &gt;&gt; /app/save.log 2&gt;&amp;1
</code></pre><p>私が運営をさせてもらっている、とあるNSで実際に使っているヘッドレスOTRPコンテナのためのDockerfileとなかまたちはこんな感じです。</p><p>git cloneすればsimutransフォルダとしてDLできるのでフォルダ名周りのややこしい処理が要らなくなるほか、save.shでは10日でsveファイルが削除される欠陥構造のため、コピペしてそのまま使えるとはいえません。<del>生成AIに渡してこの段落の文章を申し送り事項として送り付ければ直してくれることでしょう</del></p><p>なお、ヘッドレスなのにDockerfileにてGUIライブラリなどをインストールする記述がありますが、これはSimutrans World Monitorで必要なAIプレイヤーが追加されたセーブデータをWindows環境で用意するのがパスの都合で面倒だったので、コンテナ内でGUIのSimutransを立ち上げAIプレイヤーを追加できるよう、NoVNCを実行できるようにしているためです。</p><h4 id=参考このコンテナ内でnovncを使いguiのsimutransを起動する>参考）このコンテナ内でNoVNCを使いGUIのSimutransを起動する<a hidden class=anchor aria-hidden=true href=#参考このコンテナ内でnovncを使いguiのsimutransを起動する>#</a></h4><pre><code>Xvfb :99 -screen 0 1024x768x24 &amp;
export DISPLAY=:99
x11vnc -display :99 -forever -nopw -shared -bg
git clone https://github.com/novnc/noVNC.git /opt/novnc
/opt/novnc/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &amp;
DISPLAY=:99 ./sim -server 13353 -server_admin_pw 0000 -objects pak.nippon -log 1 -debug 2 -lang ja -singleuser -load ../hogehoge.sve
</code></pre><p>これらのライブラリを入れると当然ながらヘッドレスではなくなるので、configureしたときの表記が<code>WARNING: No backend found, using server (posix)!</code>から<code>WARNING: Using SDL2 backend!</code>になります。要検証ですがバックエンドがSDL2になってもヘッドレスで動いているため、多分サーバーの動作には影響がない…はず？（環境がUbuntu Serverなのでたまたまいけてるのかも）</p><hr><pre><code>sudo docker run -d -p 13353:13353 -p 6080:6080 --restart=always --name hoge -v [アドオンのフォルダのパス]:/app/pak.nippon -v [任意のパス（Discord Botコンテナとcmd.txtなどをやりとりするため）]:/app/file_io --log-opt max-size=100m --log-opt max-file=5 simutrans-server:v46
</code></pre><p>このDockerfileのコンテナを立ち上げるときのコマンドは以上のとおり。NoVNCを実行するため6080番も開けていますね。このコマンドを実行するときは、同じディレクトリにstart.shなどのファイル群やSimutrans World Monitorの中身であるsqai_hm_monitorフォルダ、セーブデータとしてsave.sveを据えておく必要があります。</p><p>ここで、セーブデータもアドオンのようにマウントすればやり取りが楽になると思った方もいると思いますが、私の環境だとセーブデータをマウントすると以下の動画のようにNSに誰かが入ると先に入ってた人が切断されてしまいました。</p><video controls preload=metadata style=width:100%;height:auto>
<source src=https://www.araduke.net/251217_2.mp4 type=video/mp4>お使いのブラウザは動画タグをサポートしていません。</video><p>ただし、save.shでセーブデータが保存されるフォルダ（/app/autosave）はホストのどこかにマウントしておくべきなので、このコマンドも要修正ものです。</p><p>なお、sqai_hm_monitor/libs/global.nutの各ファイルのパスは本稿の環境では<code>"/app/file_io/cmd.txt"</code>などのように変更しないとAIプレイヤー追加時にエラーとなります。</p><p>Docker Composeを使えばほかのコンテナと併せてデータのやり取りが楽になりそうですが、docker-compose,ymlはitzg/docker-minecraft-serverでちょっと触ったくらいの知識しかないのでまだ勉強中です。また、あるときからNS内のログを取るようにしたところサーバー機のストレージ全体がログファイルで溢れかけたので、ログファイルは最大500MB（100MBで区切って5個まで保持）となるようにしています。</p><p>以上でヘッドレスOTRPのコンテナを作ることができました。ここからは、コマンドにてマウントしてるfile_ioフォルダとファイルのやり取りをするSimutrans World MonitorのDiscord Botのコンテナを用意します。</p><h2 id=discord-botのコンテナ>Discord Botのコンテナ<a hidden class=anchor aria-hidden=true href=#discord-botのコンテナ>#</a></h2><h4 id=dockerfile生成ai製だったはずなぜgitを入れてるか分からない>Dockerfile（生成AI製だったはず　なぜgitを入れてるか分からない）<a hidden class=anchor aria-hidden=true href=#dockerfile生成ai製だったはずなぜgitを入れてるか分からない>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=w> </span><span class=s>python:3.11-slim</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 必要なパッケージをインストール</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> apt-get install -y <span class=se>\
</span></span></span><span class=line><span class=cl>    git <span class=se>\
</span></span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 作業ディレクトリを設定</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=w> </span><span class=s>/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># requirements.txt をコピーして依存関係をインストール</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> requirements.txt ./<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> pip install --no-cache-dir -r requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># Botのソースコードをコピー</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># Botの起動コマンド</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;python&#34;</span><span class=p>,</span> <span class=s2>&#34;monitor.py&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></div><h4 id=monitorpy加筆した部分のみ>monitor.py（加筆した部分のみ）<a hidden class=anchor aria-hidden=true href=#monitorpy加筆した部分のみ>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>ALLOWED_CHANNELS</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1234567891234657891</span><span class=p>,</span><span class=mi>1234567891234657891</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ALLOWED_TYPES</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;.tab&#39;</span><span class=p>,</span><span class=s1>&#39;.pak&#39;</span><span class=p>,</span><span class=s1>&#39;.zip&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>SAVE_DIR</span> <span class=o>=</span> <span class=s1>&#39;/app/data&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>intents</span> <span class=o>=</span> <span class=n>discord</span><span class=o>.</span><span class=n>Intents</span><span class=o>.</span><span class=n>default</span><span class=p>()</span>  <span class=c1># デフォルトのインテントを使う</span>
</span></span><span class=line><span class=cl><span class=n>intents</span><span class=o>.</span><span class=n>message_content</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>discord</span><span class=o>.</span><span class=n>Client</span><span class=p>(</span><span class=n>intents</span><span class=o>=</span><span class=n>intents</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tree</span> <span class=o>=</span> <span class=n>app_commands</span><span class=o>.</span><span class=n>CommandTree</span><span class=p>(</span><span class=n>client</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>GUILD_ID</span> <span class=o>=</span> <span class=mi>1234567891234567891</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tree.command</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;nurupo&#34;</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;駅員が反応します。&#34;</span><span class=p>,</span> <span class=n>guild</span><span class=o>=</span><span class=n>discord</span><span class=o>.</span><span class=n>Object</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>GUILD_ID</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>ping</span><span class=p>(</span><span class=n>interaction</span><span class=p>:</span> <span class=n>discord</span><span class=o>.</span><span class=n>Interaction</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>interaction</span><span class=o>.</span><span class=n>channel_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>ALLOWED_CHANNELS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>interaction</span><span class=o>.</span><span class=n>response</span><span class=o>.</span><span class=n>send_message</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;コマンドは指定のチャンネルでの呼び出しをお願いします。&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ephemeral</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>interaction</span><span class=o>.</span><span class=n>response</span><span class=o>.</span><span class=n>send_message</span><span class=p>(</span><span class=s2>&#34;ガッ&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tree.command</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;download_sve&#34;</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;最新のセーブデータを送信します。データは毎時5分・45分更新です。&#34;</span><span class=p>,</span> <span class=n>guild</span><span class=o>=</span><span class=n>discord</span><span class=o>.</span><span class=n>Object</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>GUILD_ID</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>download_sve</span><span class=p>(</span><span class=n>interaction</span><span class=p>:</span> <span class=n>discord</span><span class=o>.</span><span class=n>Interaction</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>interaction</span><span class=o>.</span><span class=n>channel_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>ALLOWED_CHANNELS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>interaction</span><span class=o>.</span><span class=n>response</span><span class=o>.</span><span class=n>send_message</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;コマンドは指定のチャンネルでの呼び出しをお願いします。&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ephemeral</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>interaction</span><span class=o>.</span><span class=n>response</span><span class=o>.</span><span class=n>defer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>autosave_dir</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&#34;/app/autosave&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sve_files</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>autosave_dir</span><span class=o>.</span><span class=n>glob</span><span class=p>(</span><span class=s2>&#34;*.sve&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>latest_file</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>sve_files</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>f</span><span class=p>:</span> <span class=n>f</span><span class=o>.</span><span class=n>stat</span><span class=p>()</span><span class=o>.</span><span class=n>st_mtime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>interaction</span><span class=o>.</span><span class=n>followup</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>file</span><span class=o>=</span><span class=n>discord</span><span class=o>.</span><span class=n>File</span><span class=p>(</span><span class=n>latest_file</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># メッセージ受信時に動作する処理</span>
</span></span><span class=line><span class=cl><span class=nd>@client.event</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>on_message</span><span class=p>(</span><span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># メッセージ送信者がBotだった場合は無視する</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>message</span><span class=o>.</span><span class=n>author</span><span class=o>.</span><span class=n>bot</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>message</span><span class=o>.</span><span class=n>channel</span><span class=o>.</span><span class=n>id</span> <span class=ow>in</span> <span class=n>ALLOWED_CHANNELS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>message</span><span class=o>.</span><span class=n>attachments</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>attachment</span> <span class=ow>in</span> <span class=n>message</span><span class=o>.</span><span class=n>attachments</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>file</span> <span class=o>=</span> <span class=n>attachment</span><span class=o>.</span><span class=n>filename</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>any</span><span class=p>(</span><span class=n>file</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=n>ext</span><span class=p>)</span> <span class=k>for</span> <span class=n>ext</span> <span class=ow>in</span> <span class=n>ALLOWED_TYPES</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># ファイルを保存</span>
</span></span><span class=line><span class=cl>                <span class=n>save_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>SAVE_DIR</span><span class=p>,</span> <span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=n>attachment</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>save_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>file</span><span class=si>}</span><span class=s2> を保存しました。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=n>message</span><span class=o>.</span><span class=n>add_reaction</span><span class=p>(</span><span class=s2>&#34;👍&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>コンテナの立ち上げコマンドは次のとおり。</p><pre><code>sudo docker run -d --restart=always --name discord-bot -v [任意のパス（Discord Botコンテナとcmd.txtなどをやりとりするため）]:/app/file_io -v [受け取ったpakファイルを置く場所]:/app/data discord-bot:latest
</code></pre><p>Simutrans Wolrd Monitorを使用していると（要検証）、クライアント側に保存される<code>client-network.sve</code>のようなセーブデータがローカルで開けなくなる現象があり、サーバー側のオートセーブを持ってきて投稿するスラッシュコマンドをこさえていますが、セーブデータがDiscordの容量制限のせいで投稿できないため凍結されています。</p><p>また、リポジトリのreadmeではSimutransとDiscord Botの起動順序の言及がありますが、私の環境ではどちらが先でも動いてくれました。</p><h2 id=アドオン追加更新を自動化>アドオン追加・更新を自動化<a hidden class=anchor aria-hidden=true href=#アドオン追加更新を自動化>#</a></h2><p>以下のスクリプト類は生成AIの力を借りて突貫で作成したもののため、「こうやってるのがあるらしい」と生成AIに投げるために使う程度に留めたほうがよいです。</p><h3 id=nginxのwebサーバー>nginxのwebサーバー<a hidden class=anchor aria-hidden=true href=#nginxのwebサーバー>#</a></h3><h4 id=docker-composeyaml>docker-compose.yaml<a hidden class=anchor aria-hidden=true href=#docker-composeyaml>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl>version: <span class=s1>&#39;3.8&#39;</span><span class=err>
</span></span></span><span class=line><span class=cl>services:<span class=err>
</span></span></span><span class=line><span class=cl>  nginx:<span class=err>
</span></span></span><span class=line><span class=cl>    image: nginx:stable-alpine<span class=err>
</span></span></span><span class=line><span class=cl>    container_name: simutrans_web_server<span class=err>
</span></span></span><span class=line><span class=cl>    ports:<span class=err>
</span></span></span><span class=line><span class=cl>      - <span class=s2>&#34;8080:80&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl>    volumes:<span class=err>
</span></span></span><span class=line><span class=cl>      - <span class=o>[</span>任意のフォルダ<span class=o>]</span>:/usr/share/nginx/html/pak_update:ro<span class=err>
</span></span></span><span class=line><span class=cl>    restart: always<span class=err>
</span></span></span></code></pre></div><p>このwebサーバーをtailscale funnelで公開します（コマンドは書きとめてなかったようです）。</p><h3 id=参加者に実行してもらうスクリプト>参加者に実行してもらうスクリプト<a hidden class=anchor aria-hidden=true href=#参加者に実行してもらうスクリプト>#</a></h3><h4 id=setupbatotrpのバージョン確認が欠陥>setup.bat（OTRPのバージョン確認が欠陥）<a hidden class=anchor aria-hidden=true href=#setupbatotrpのバージョン確認が欠陥>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bat data-lang=bat><span class=line><span class=cl><span class=p>@</span><span class=k>echo</span> off
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>cd</span> /d <span class=s2>&#34;</span><span class=nv>%~dp0</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=nv>SIMUTRANS_VER</span><span class=p>=</span>122-0
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=nv>OTRP_VER</span><span class=p>=</span>v44_3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=nv>OUTPUT_FILE</span><span class=p>=</span>simuwin-<span class=nv>%SIMUTRANS_VER%</span>.zip
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=nv>OTRP_OUTPUT_FILE</span><span class=p>=</span>sim-WinGDI64-OTRP<span class=nv>%OTRP_VER%</span>.zip
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span> simutransをセットアップします
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=k>not</span> <span class=k>exist</span> simutrans.exe <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> simutransをダウンロードします
</span></span><span class=line><span class=cl>    curl -L -o <span class=s2>&#34;</span><span class=nv>%OUTPUT_FILE%</span><span class=s2>&#34;</span> <span class=s2>&#34;https://sourceforge.net/projects/simutrans/files/simutrans/</span><span class=nv>%SIMUTRANS_VER%</span><span class=s2>/simuwin-</span><span class=nv>%SIMUTRANS_VER%</span><span class=s2>.zip/download&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    powershell -Command <span class=s2>&#34;Expand-Archive -Path &#39;</span><span class=nv>%OUTPUT_FILE%</span><span class=s2>&#39; -DestinationPath &#39;.&#39; -Force&#34;</span>
</span></span><span class=line><span class=cl>    robocopy simutrans . /E /MOVE
</span></span><span class=line><span class=cl>    <span class=k>rmdir</span> simutrans
</span></span><span class=line><span class=cl>    <span class=k>del</span> <span class=nv>%OUTPUT_FILE%</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> simutransのセットアップが完了しました
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=k>else</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> simutransのセットアップは完了しています
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span>.
</span></span><span class=line><span class=cl><span class=k>echo</span> OTRPをセットアップします
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=k>not</span> <span class=k>exist</span> sim-WinGDI64-OTRPv44_3.exe <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> OTRP <span class=nv>%OTRP_VER%</span> をダウンロードします
</span></span><span class=line><span class=cl>    curl -L -o <span class=s2>&#34;</span><span class=nv>%OTRP_OUTPUT_FILE%</span><span class=s2>&#34;</span> <span class=s2>&#34;https://github.com/teamhimeh/simutrans/releases/download/</span><span class=nv>%OTRP_VER%</span><span class=s2>/sim-WinGDI64-OTRP</span><span class=nv>%OTRP_VER%</span><span class=s2>.zip&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    powershell -Command <span class=s2>&#34;Expand-Archive -Path &#39;</span><span class=nv>%OTRP_OUTPUT_FILE%</span><span class=s2>&#39; -DestinationPath &#39;.&#39; -Force&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>del</span> <span class=nv>%OTRP_OUTPUT_FILE%</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> OTRPのセットアップが完了しました
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=k>else</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> OTRPのセットアップは完了しています
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span>.
</span></span><span class=line><span class=cl><span class=k>echo</span> セットアップが完了しました
</span></span><span class=line><span class=cl><span class=k>echo</span> 続いて、simutrans-updater.batを実行してpakファイルをダウンロードしてください。
</span></span><span class=line><span class=cl><span class=k>pause</span>
</span></span></code></pre></div><h4 id=simutrans-updaterbat>simutrans-updater.bat<a hidden class=anchor aria-hidden=true href=#simutrans-updaterbat>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bat data-lang=bat><span class=line><span class=cl><span class=p>@</span><span class=k>echo</span> off
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>REM ここに起動したいsimutransのファイル名を書く（例：simutrans.exe、sim-WinGDI64-OTRPv44_3.exeなど）</span>
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=nv>SIMUTRANS_PATH</span><span class=p>=</span>sim-WinGDI64-OTRPv44_3.exe
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=nv>PAK_FOLDER</span><span class=p>=</span>pak
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=nv>VERSION_URL</span><span class=p>=</span>https://hoge.tail123abc.ts.net/pak_update/pakversion.txt
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=nv>ZIP_URL</span><span class=p>=</span>https://hoge.tail123abc.ts.net/pak_update/release.zip
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>cd</span> /d <span class=s2>&#34;</span><span class=nv>%~dp0</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>REM exeの存在確認</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=k>not</span> <span class=k>exist</span> <span class=s2>&#34;</span><span class=nv>%SIMUTRANS_PATH%</span><span class=s2>&#34;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> 実行ファイル <span class=nv>%SIMUTRANS_PATH%</span> が見つかりません。batファイルをメモ帳で開き、SIMUTRANS_PATHに起動したいsimutransのファイル名を書いてください（例：simutrans.exe、sim-WinGDI64-OTRPv44_3.exeなど）
</span></span><span class=line><span class=cl>    <span class=k>pause</span>
</span></span><span class=line><span class=cl>    <span class=k>exit</span> /b
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>REM ローカルのpakversionの存在確認</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> ローカルのバージョンを確認しています
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=nv>LOCAL_VER</span><span class=p>=</span>0
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=k>exist</span> pakversion.txt <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>set</span> <span class=k>/p</span> <span class=nv>LOCAL_VER</span><span class=p>=&lt;</span>pakversion.txt
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>%LOCAL_VER%</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>REM webサーバー上のバージョン取得</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> 更新情報を読み込みます
</span></span><span class=line><span class=cl>curl -s <span class=nv>%VERSION_URL%</span> <span class=p>&gt;</span> pakversion.tmp
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=k>/p</span> <span class=nv>WEB_VER</span><span class=p>=&lt;</span>pakversion.tmp
</span></span><span class=line><span class=cl><span class=k>del</span> pakversion.tmp
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>%WEB_VER%</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=k>/a</span> <span class=nv>LOCAL_NUM</span><span class=o>=%</span><span class=nv>LOCAL_VER</span><span class=o>%</span>
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=k>/a</span> <span class=nv>WEB_NUM</span><span class=o>=%</span><span class=nv>WEB_VER</span><span class=o>%</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nv>%LOCAL_NUM%</span> <span class=ow>GEQ</span> <span class=nv>%WEB_NUM%</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> ローカルのバージョンは最新です
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=k>else</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> 新しいバージョンが存在します。pakの更新をしています...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=k>exist</span> <span class=s2>&#34;</span><span class=nv>%PAK_FOLDER%</span><span class=s2>&#34;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>rmdir</span> /s /q <span class=s2>&#34;</span><span class=nv>%PAK_FOLDER%</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    powershell -Command <span class=s2>&#34;(New-Object System.Net.WebClient).DownloadFile(&#39;</span><span class=nv>%ZIP_URL%</span><span class=s2>&#39;, &#39;release.zip&#39;)&#34;</span>
</span></span><span class=line><span class=cl>    powershell -Command <span class=s2>&#34;Expand-Archive -Path &#39;release.zip&#39; -DestinationPath &#39;.&#39; -Force&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>del</span> release.zip
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>&gt;</span> pakversion.txt <span class=k>echo</span> <span class=nv>%WEB_VER%</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> アップデートが完了しました
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span> ゲームを起動します
</span></span><span class=line><span class=cl><span class=k>start</span> <span class=s2>&#34;&#34;</span> <span class=s2>&#34;</span><span class=nv>%SIMUTRANS_PATH%</span><span class=s2>&#34;</span> -objects <span class=s2>&#34;</span><span class=nv>%PAK_FOLDER%</span><span class=s2>&#34;</span>
</span></span></code></pre></div><h3 id=アドオンを追加する側の動作>アドオンを追加する側の動作<a hidden class=anchor aria-hidden=true href=#アドオンを追加する側の動作>#</a></h3><p>やってることは<a href="https://ahozura.kasu.me/portal/?p=2195">先駆者様</a>と同じでほぼ真似てるといえるのでアドオンをリポジトリで管理しています。ただGithub Actionがうまくいかず追加手順は手動です。</p><h4 id=更新手順windows環境>更新手順（Windows環境）<a hidden class=anchor aria-hidden=true href=#更新手順windows環境>#</a></h4><pre><code>git add .
git commit -m &quot;変更点をここに書く&quot;
git tag -a 20251217 -m &quot;追加分&quot;
git push origin --tags
</code></pre><h4 id=after_pushbat>after_push.bat<a hidden class=anchor aria-hidden=true href=#after_pushbat>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bat data-lang=bat><span class=line><span class=cl><span class=p>@</span><span class=k>echo</span> off
</span></span><span class=line><span class=cl>chcp 65001 <span class=p>&gt;</span>nul
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=s2>&#34;MAKEOBJ_PATH=...\makeobj-win-60-7\makeobj.exe&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>cd</span> /d <span class=s2>&#34;</span><span class=nv>%~dp0</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>REM Gitリポジトリか確認</span>
</span></span><span class=line><span class=cl>git rev-parse --is-inside-work-tree <span class=p>&gt;</span>nul <span class=mi>2</span><span class=p>&gt;&amp;</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=k>errorlevel</span> <span class=mi>1</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> このフォルダはGitリポジトリではありません。
</span></span><span class=line><span class=cl>    <span class=k>pause</span>
</span></span><span class=line><span class=cl>    <span class=k>exit</span> /b 1
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>REM 最新コミットに付いているタグを取得（なければ空）</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=k>/f</span> <span class=s2>&#34;delims=&#34;</span> <span class=se>%%</span>T <span class=k>in</span> <span class=p>(</span><span class=s1>&#39;git tag --points-at HEAD&#39;</span><span class=p>)</span> <span class=k>do</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=se>%%</span>T <span class=p>&gt;</span> pakversion.txt
</span></span><span class=line><span class=cl>    <span class=k>goto</span> <span class=p>:</span><span class=nl>done</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>REM タグが無ければファイル作成せず通知（必要なら空ファイルを作ってもよい）</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> 最新のコミットにはタグが付いていません。
</span></span><span class=line><span class=cl><span class=k>goto</span> <span class=p>:</span><span class=nl>eof</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=nl>done</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> 最新のタグを pakversion.txt に出力しました。
</span></span><span class=line><span class=cl><span class=k>type</span> pakversion.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=k>exist</span> <span class=s2>&#34;release&#34;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> release フォルダを空にします。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>del</span> /q /f <span class=s2>&#34;release\*&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> /d <span class=se>%%</span>D <span class=k>in</span> <span class=p>(</span><span class=s2>&#34;release\*&#34;</span><span class=p>)</span> <span class=k>do</span> <span class=k>rd</span> /s /q <span class=s2>&#34;</span><span class=se>%%</span><span class=s2>D&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> 完了しました！
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=k>else</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> release フォルダが見つかりません。
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>REM pakフォルダを作成</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=k>not</span> <span class=k>exist</span> <span class=s2>&#34;release\pak&#34;</span> <span class=k>mkdir</span> <span class=s2>&#34;release\pak&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>REM ground.Outsideを移動してmerge、その他もろもろをコピー</span>
</span></span><span class=line><span class=cl><span class=k>copy</span> /Y <span class=s2>&#34;pak-data\ground.Outside.pak&#34;</span> <span class=s2>&#34;release\pak\&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;</span><span class=nv>%MAKEOBJ_PATH%</span><span class=s2>&#34;</span> merge <span class=s2>&#34;release\pak\boot.pak&#34;</span> <span class=s2>&#34;pak-data\*.pak&#34;</span>
</span></span><span class=line><span class=cl>robocopy <span class=s2>&#34;pak-data&#34;</span> <span class=s2>&#34;release\pak&#34;</span> /E /XF *.pak
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>REM PowerShellのCompress-Archiveを使ってzipに</span>
</span></span><span class=line><span class=cl>powershell -Command <span class=s2>&#34;Compress-Archive -Path &#39;release\*&#39; -DestinationPath &#39;release.zip&#39; -Force&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>REM scpでzipとpakversionをwebサーバーに配置</span>
</span></span><span class=line><span class=cl>scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null <span class=s2>&#34;release.zip&#34;</span> [サーバー機のWebサーバーのパス]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nv>%ERRORLEVEL%</span> <span class=ow>EQU</span> 0 <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> SCP転送成功
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=k>else</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> SCP転送失敗 エラーコード: <span class=nv>%ERRORLEVEL%</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null <span class=s2>&#34;pakversion.txt&#34;</span> [サーバー機のWebサーバーのパス]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nv>%ERRORLEVEL%</span> <span class=ow>EQU</span> 0 <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> SCP転送成功
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=k>else</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> SCP転送失敗 エラーコード: <span class=nv>%ERRORLEVEL%</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>REM sshでpakフォルダの中身を消してscpで新しいpakフォルダの中身を転送してくる</span>
</span></span><span class=line><span class=cl>ssh <span class=s2>&#34;rm -rf [サーバー機のアドオンフォルダ]&#34;</span>
</span></span><span class=line><span class=cl>scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -r <span class=s2>&#34;release\pak\.&#34;</span> [サーバー機のWebサーバーのパス]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>REM dockerコンテナの再起動</span>
</span></span><span class=line><span class=cl>ssh <span class=s2>&#34;sudo docker restart hoge&#34;</span>
</span></span><span class=line><span class=cl><span class=k>pause</span>
</span></span></code></pre></div><h2 id=おわりに>おわりに<a hidden class=anchor aria-hidden=true href=#おわりに>#</a></h2><p>いかがでしたか？</p><p>後半は息絶えてますが、こんな感じでNSを立てると冒頭に触れた機能を持ったサーバーができます。Dockerfileもそのまま使えるかは怪しいのであまり役に立たない記事ですが、あなたの鯖立てに少しでも貢献できていたら嬉しいです。</p><p>さいごに、1週間の大遅刻となってしまいすみませんでした……。</p><p>それではよいSimutransライフを！</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.araduke.net/tags/%E6%8A%80%E8%A1%93/>技術</a></li><li><a href=https://www.araduke.net/tags/simutrans/>Simutrans</a></li><li><a href=https://www.araduke.net/tags/netsimutrans/>NetSimutrans</a></li><li><a href=https://www.araduke.net/tags/docker/>Docker</a></li><li><a href=https://www.araduke.net/tags/ipoe/>IPoE</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.araduke.net/>漬けなくてもおいしい</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>